_ = require 'lodash'
#
# Two things here.
# First, the snapshot should contain every visual information needed.
# Second, there must be identities

## the snapshot part #####################################

@snapshot = (game, viewpoint)->
	view = []
	@iterate game.root, (one)=>
		render = @viewEntity one, viewpoint
		@recordEntity one, render, view, viewpoint.id
	layout = game.module.layout(game.options)
	return {
		view : view
		layout : layout
	}

@iterate = (entity, func)->
	func entity
	_.forEach entity.children(), (one)=>
		@iterate one, func

@viewEntity = (entity, viewpoint)->
	return null if not entity.Viewable
	return entity.Viewable.render viewpoint

@recordEntity = (entity, view, list, vp)->
	return if not view
	list.push view

## the watch part ########################################

@watchby = (viewpoint, handler)->
	game = viewpoint.game()
	watchers = game.watchers = game.watchers or {}
	watchers[viewpoint.id] =
		watcher : viewpoint
		handler : handler

@unwatchby = (viewpoint)->
	game = viewpoint.game()
	watchers = game.watchers = game.watchers or {}
	delete watchers[viewpoint.id]